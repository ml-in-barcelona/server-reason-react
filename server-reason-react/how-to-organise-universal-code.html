<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>how-to-organise-universal-code (server-reason-react.how-to-organise-universal-code)</title><meta charset="utf-8"/><link rel="stylesheet" href="../odoc.css"/><meta name="generator" content="odoc 3.1.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>let base_url = '../';
let search_urls = ['sherlodoc_db.js','../sherlodoc.js'];
</script><script src="../odoc_search.js" defer="defer"></script></head><body class="odoc"><nav class="odoc-nav"><a href="index.html">Up</a> â€“ <a href="../index.html">Package index</a> &#x00BB; <a href="index.html">server-reason-react</a> &#x00BB; How to organise universal code</nav><div class="odoc-search"><div class="search-inner"><input class="search-bar" placeholder="ðŸ”Ž Type '/' to search..."/><div class="search-snake"></div><div class="search-result"></div></div></div><header class="odoc-preamble"><h1 id="how-to-organise-universal-code"><a href="#how-to-organise-universal-code" class="anchor"></a>How to organise universal code</h1><p>While using <code>server-reason-react</code> it's important to know how to organise the code. Sometimes you may want to have components that are shared between the client and the server, and sometimes you want to have components that are only used by the client or by the server.</p><p>In this guide will show how to setup the dune files accordingly.</p></header><div class="odoc-tocs"><nav class="odoc-toc odoc-local-toc"><ul><li><a href="#copy_files">The copy_files hack</a></li><li><a href="#components">reason-react and server-reason-react</a></li><li><a href="#virtual">Note on virtual_libraries</a></li><li><a href="#future">Future</a></li></ul></nav><nav class="odoc-toc odoc-global-toc"><ul><li><a href="index.html">server-reason-react</a><ul><li><a href="get-started.html">Get started</a></li><li><a href="universal-code.html">What does universal code mean</a></li><li><a href="#" class="current_unit">How to organise universal code</a></li><li><a href="browser_ppx.html">Exclude client code from the native build</a></li><li><a href="externals-melange-attributes.html">Externals and melange attributes</a></li><li><a href="ssr-and-hydration.html">Server-side rendering and hydration</a></li><li>Library <code>server-reason-react.base32</code><ul><li><a href="server-reason-react.base32/Base32/index.html">Base32</a></li></ul></li><li>Library <code>server-reason-react.belt</code><ul><li><a href="server-reason-react.belt/Belt/index.html">Belt</a></li></ul></li><li>Library <code>server-reason-react.browser_ppx</code><ul><li><a href="server-reason-react.browser_ppx/Browser_ppx/index.html">Browser_ppx</a></li></ul></li><li>Library <code>server-reason-react.dom</code><ul><li><a href="server-reason-react.dom/Dom/index.html">Dom</a></li></ul></li><li>Library <code>server-reason-react.fetch</code><ul><li><a href="server-reason-react.fetch/Fetch/index.html">Fetch</a></li></ul></li><li>Library <code>server-reason-react.html</code><ul><li><a href="server-reason-react.html/Html/index.html">Html</a></li></ul></li><li>Library <code>server-reason-react.js</code><ul><li><a href="server-reason-react.js/Js/index.html">Js</a></li></ul></li><li>Library <code>server-reason-react.melange_ppx</code><ul><li><a href="server-reason-react.melange_ppx/Melange_native_ppx/index.html">Melange_native_ppx</a></li></ul></li><li>Library <code>server-reason-react.ppx</code><ul><li><a href="server-reason-react.ppx/Server_reason_react_ppx/index.html">Server_reason_react_ppx</a></li></ul></li><li>Library <code>server-reason-react.promise-native</code><ul><li><a href="server-reason-react.promise-native/Promise/index.html">Promise</a></li></ul></li><li>Library <code>server-reason-react.react</code><ul><li><a href="server-reason-react.react/React/index.html">React</a></li><li><a href="server-reason-react.react/ReactEvent/index.html">ReactEvent</a></li><li><a href="server-reason-react.react/ReasonReactRouter/index.html">ReasonReactRouter</a></li></ul></li><li>Library <code>server-reason-react.reactDom</code><ul><li><a href="server-reason-react.reactDom/ReactDOM/index.html">ReactDOM</a></li><li><a href="server-reason-react.reactDom/ReactDOMStyle/index.html">ReactDOMStyle</a></li><li><a href="server-reason-react.reactDom/ReactServerDOM/index.html">ReactServerDOM</a></li></ul></li><li>Library <code>server-reason-react.runtime</code><ul><li><a href="server-reason-react.runtime/Runtime/index.html">Runtime</a></li></ul></li><li>Library <code>server-reason-react.url_native</code><ul><li><a href="server-reason-react.url_native/URL/index.html">URL</a></li></ul></li><li>Library <code>server-reason-react.webapi</code><ul><li><a href="server-reason-react.webapi/Webapi/index.html">Webapi</a></li></ul></li><li>Library <code>server-reason-react.xxhash</code><ul><li><a href="server-reason-react.xxhash/XXH64/index.html">XXH64</a></li></ul></li><li><a href="src/index.html">Sources</a></li></ul></li></ul></nav></div><div class="odoc-content"><h2 id="copy_files"><a href="#copy_files" class="anchor"></a>The copy_files hack</h2><p>In order to reuse the same code, you can use <a href="https://dune.readthedocs.io/en/stable/reference/dune/copy_files.html">(copy_files ...)</a>. It seems hacky, and eventually we will have better ways of doing so, but is the method I found to be more reliable in terms of developer experience, mostly editor support and error messages.</p><pre class="language-ocaml"><code>- src
  - client/
    - dune
  - server/
    - shared/
        &lt;library-code-here&gt;
    - dune
</code></pre><pre class="language-ocaml"><code>(* client/dune *)
(library
  (name url_js)
  (modes melange)
  (libraries melange.js)
  (wrapped false)
  (modules Url)
  (preprocess (pps melange.ppx))

(copy_files#
 (source_only)
 (mode fallback) ; `mode fallback` means you can override files in the client folder
 (files &quot;../native/shared/**.{re,rei}&quot;))</code></pre><pre class="language-ocaml"><code>(* server/dune *)
(library
  (name url_native)
  (modes native)
  (modules Url)
  (wrapped false))</code></pre><p>Here's the <a href="https://github.com/ml-in-barcelona/server-reason-react/tree/main/demo/universal">universal demo</a></p><h2 id="components"><a href="#components" class="anchor"></a>reason-react and server-reason-react</h2><p>Asuming you want to share react.components between the client and the server, you can use the same technique as above.</p><pre class="language-ocaml"><code>(library
 (name shared_js)
 (modes melange)
 (libraries reason_react melange.belt bs_webapi)
 (wrapped false)
 (preprocess
  (pps melange.ppx reason-react-ppx)))

(copy_files# &quot;../native/shared/*.re&quot;)

(library
 (name shared_native)
 (modes native)
 (libraries
  server-reason-react.react
  server-reason-react.reactDom
  server-reason-react.belt
  server-reason-react.webapi)
 (wrapped false)
 (preprocess
  (pps
    server-reason-react.ppx
    server-reason-react.browser_ppx
    server-reason-react.melange_ppx)))

(copy_files# &quot;../*.re&quot;)</code></pre><p>This will expose all modules under a `Shared` module. You can then use those modules in both the client and the server.</p><pre class="language-ocaml"><code>  // client.re

  switch (ReactDOM.querySelector(&quot;#root&quot;)) {
  | Some(el) =&gt;
    let root = ReactDOM.Client.hydrateRoot(el);
    ReactDOM.Client.hydrate(&lt;Shared.App /&gt;, root);
  | None =&gt; Js.log(&quot;Can't find a 'root' element&quot;)
  };</code></pre><pre class="language-ocaml"><code>  // server.re
  // Given a random server library, and a random Page component

  module Page = {
    [@react.component]
    let make = (~children, ~scripts) =&gt; {
      &lt;html&gt;
        &lt;head&gt;
          &lt;meta charSet=&quot;UTF-8&quot; /&gt;
          &lt;meta
            name=&quot;viewport&quot;
            content=&quot;width=device-width, initial-scale=1.0&quot;
          /&gt;
          &lt;title&gt; {React.string(&quot;Server Reason React demo&quot;)} &lt;/title&gt;
          &lt;link
            rel=&quot;shortcut icon&quot;
            href=&quot;https://reasonml.github.io/img/icon_50.png&quot;
          /&gt;
          &lt;script src=&quot;https://cdn.tailwindcss.com&quot; /&gt;
        &lt;/head&gt;
        &lt;body&gt; &lt;div id=&quot;root&quot;&gt; children &lt;/div&gt; &lt;/body&gt;
      &lt;/html&gt;;
    };
  };

  // ...
  req =&gt; {
    let html = ReactDOM.renderToString(&lt;Page&gt; &lt;Shared.App /&gt; &lt;/Page&gt;);
    Httpd.Response.make_string(Ok(html));
  }</code></pre><h2 id="virtual"><a href="#virtual" class="anchor"></a>Note on virtual_libraries</h2><p>There's a better mechanism of doing the same thing by dune, which is <a href="https://dune.readthedocs.io/en/stable/variants.html">Virtual libraries</a>.</p><p>However, there are a few limitations on virtual libraries:</p><ul><li><b>Require all types to be abstract</b></li><li>There are some <a href="https://dune.readthedocs.io/en/stable/variants.html#limitations">known limitations</a></li><li><a href="https://github.com/ocaml/dune/issues/7104">Some inconsistent behaviour</a></li></ul><p>I found that this mechanism is not as reliable as copy_files, and it's not well supported by editors. I would recommend to use copy_files instead, while we explore better ways of doing so with the dune team.</p><h2 id="future"><a href="#future" class="anchor"></a>Future</h2><p>We know that the copy_file hack is not the best way, and we are exploring better ways of doing so with the dune.</p><p>Current efforts are focused on an RFC, to enable single-context Universal Libraries <a href="https://github.com/ocaml/dune/issues/10630">dune#10630</a>.</p></div></body></html>
