(melange.emit
 (enabled_if
  (= %{profile} dev))
 (alias melange-app)
 (target app)
 (modules index)
 (libraries melange demo_shared_js reason-react melange.dom melange-webapi)
 (preprocess
  (pps browser_ppx -js reason-react-ppx melange.ppx))
 (module_systems
  (es6 js)))

(rule
 (enabled_if
  (= %{profile} dev))
 (alias client)
 (deps
  (alias_rec melange-app)
  (:script build.mjs))
 (target app.js)
 (action
  (progn
   (run node %{script} app/demo/client/index.js %{target}))))

(rule
 (enabled_if
  (= %{profile} dev))
 (alias client)
 (deps
  (alias_rec melange-app)
  (:input create-from-fetch.jsx)
  (:script build.mjs))
 (action
  (progn
   (run node %{script} %{input} app/demo/client/))))

(rule
 (enabled_if
  (= %{profile} dev))
 (alias client)
 (target bootstrap.js)
 (deps
  (alias_rec melange-app)
  (:input create-from-readable-stream.jsx)
  (:script build.mjs)
  (:extract %{bin:server_reason_react.extract_client_components}))
 (action
  (progn
   ; (with-stdout-to
   ; %{target}
   ; (run %{extract} app))
   (run node %{script} %{input} app/demo/client/))))
